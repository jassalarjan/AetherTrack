<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notification Test - TaskFlow</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      color: #667eea;
      margin: 0 0 10px 0;
    }
    .status {
      padding: 10px;
      border-radius: 6px;
      margin: 10px 0;
      font-weight: 500;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
    }
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      margin: 5px;
      font-weight: 500;
    }
    button:hover {
      background: #5568d3;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    pre {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 13px;
    }
    .log {
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.5;
    }
    .emoji {
      font-size: 20px;
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>üîî TaskFlow Notification Test</h1>
    <p>Use this page to test if notifications are working properly</p>
  </div>

  <div class="card">
    <h2>üìä Status Check</h2>
    <div id="status"></div>
  </div>

  <div class="card">
    <h2>üß™ Tests</h2>
    <button onclick="requestPermission()">1. Request Permission</button>
    <button onclick="testBasicNotification()">2. Test Basic Notification</button>
    <button onclick="testServiceWorkerNotification()">3. Test SW Notification</button>
    <button onclick="runFullDiagnostic()">4. Run Full Diagnostic</button>
    <button onclick="clearLogs()">Clear Logs</button>
  </div>

  <div class="card">
    <h2>üìù Console Output</h2>
    <div id="logs" class="log"></div>
  </div>

  <script>
    const logsDiv = document.getElementById('logs');
    const statusDiv = document.getElementById('status');

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const div = document.createElement('div');
      div.innerHTML = `<span style="color: #888">[${timestamp}]</span> ${message}`;
      logsDiv.appendChild(div);
      logsDiv.scrollTop = logsDiv.scrollHeight;
      console.log(message);
    }

    function clearLogs() {
      logsDiv.innerHTML = '';
    }

    function updateStatus() {
      let html = '';
      
      // Check Notification API
      if ('Notification' in window) {
        html += `<div class="status success">‚úÖ Notification API: Supported</div>`;
        html += `<div class="status ${Notification.permission === 'granted' ? 'success' : Notification.permission === 'denied' ? 'error' : 'warning'}">
          ${Notification.permission === 'granted' ? '‚úÖ' : Notification.permission === 'denied' ? '‚ùå' : '‚ö†Ô∏è'} 
          Permission: ${Notification.permission}
        </div>`;
      } else {
        html += `<div class="status error">‚ùå Notification API: Not Supported</div>`;
      }

      // Check Service Worker
      if ('serviceWorker' in navigator) {
        html += `<div class="status success">‚úÖ Service Worker API: Supported</div>`;
        navigator.serviceWorker.getRegistration().then(reg => {
          if (reg) {
            html += `<div class="status success">‚úÖ Service Worker: Registered</div>`;
            html += `<div class="status info">‚ÑπÔ∏è SW State: ${reg.active?.state || 'installing'}</div>`;
            statusDiv.innerHTML = html;
          } else {
            html += `<div class="status warning">‚ö†Ô∏è Service Worker: Not Registered</div>`;
            statusDiv.innerHTML = html;
          }
        });
      } else {
        html += `<div class="status error">‚ùå Service Worker API: Not Supported</div>`;
      }

      // Check PWA
      const isPWA = window.matchMedia('(display-mode: standalone)').matches;
      html += `<div class="status ${isPWA ? 'success' : 'info'}">
        ${isPWA ? '‚úÖ' : '‚ÑπÔ∏è'} PWA Mode: ${isPWA ? 'Running as PWA' : 'Running in browser'}
      </div>`;

      statusDiv.innerHTML = html;
    }

    async function requestPermission() {
      log('üîî Requesting notification permission...');
      
      if (!('Notification' in window)) {
        log('‚ùå Notification API not supported!', 'error');
        return;
      }

      try {
        const permission = await Notification.requestPermission();
        log(`‚úÖ Permission result: ${permission}`);
        updateStatus();
        
        if (permission === 'granted') {
          log('üéâ Success! You can now receive notifications.');
        } else if (permission === 'denied') {
          log('‚ö†Ô∏è Permission denied. Check browser settings to reset.', 'warning');
        }
      } catch (error) {
        log(`‚ùå Error requesting permission: ${error.message}`, 'error');
      }
    }

    async function testBasicNotification() {
      log('üß™ Testing basic notification...');
      
      if (!('Notification' in window)) {
        log('‚ùå Notification API not supported!', 'error');
        return;
      }

      if (Notification.permission !== 'granted') {
        log('‚ö†Ô∏è Permission not granted. Click "Request Permission" first.', 'warning');
        return;
      }

      try {
        const notification = new Notification('üß™ Test Notification', {
          body: 'This is a basic browser notification (not using service worker)',
          icon: '/icons/pwa-192x192.png',
          badge: '/icons/pwa-64x64.png',
          tag: 'test-basic',
          requireInteraction: false,
        });

        notification.onclick = () => {
          log('‚úÖ Notification clicked!');
          notification.close();
        };

        log('‚úÖ Basic notification sent!');
      } catch (error) {
        log(`‚ùå Error showing notification: ${error.message}`, 'error');
      }
    }

    async function testServiceWorkerNotification() {
      log('üß™ Testing service worker notification...');
      
      if (!('serviceWorker' in navigator)) {
        log('‚ùå Service Worker not supported!', 'error');
        return;
      }

      if (Notification.permission !== 'granted') {
        log('‚ö†Ô∏è Permission not granted. Click "Request Permission" first.', 'warning');
        return;
      }

      try {
        const registration = await navigator.serviceWorker.getRegistration();
        
        if (!registration) {
          log('‚ö†Ô∏è No service worker registered. This is normal in dev mode.', 'warning');
          log('‚ÑπÔ∏è Falling back to basic notification...');
          testBasicNotification();
          return;
        }

        log(`‚úÖ Service worker found: ${registration.active?.state}`);
        
        await registration.showNotification('üß™ Service Worker Test', {
          body: 'This notification is shown via the service worker',
          icon: '/icons/pwa-192x192.png',
          badge: '/icons/pwa-64x64.png',
          tag: 'test-sw',
          requireInteraction: false,
          data: {
            type: 'test',
            timestamp: Date.now(),
          },
          actions: [
            { action: 'view', title: 'View' },
            { action: 'close', title: 'Close' },
          ],
        });

        log('‚úÖ Service worker notification sent!');
      } catch (error) {
        log(`‚ùå Error: ${error.message}`, 'error');
      }
    }

    async function runFullDiagnostic() {
      clearLogs();
      log('üîç Running full diagnostic...');
      log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
      
      // 1. Browser Info
      log('üì± Browser Information:');
      log(`   User Agent: ${navigator.userAgent}`);
      log(`   Platform: ${navigator.platform}`);
      log(`   Online: ${navigator.onLine ? 'Yes' : 'No'}`);
      log('');

      // 2. Notification API
      log('üîî Notification API:');
      if ('Notification' in window) {
        log('   ‚úÖ Supported');
        log(`   Permission: ${Notification.permission}`);
        log(`   Max Actions: ${Notification.maxActions || 'Unknown'}`);
      } else {
        log('   ‚ùå Not Supported');
      }
      log('');

      // 3. Service Worker
      log('‚öôÔ∏è Service Worker:');
      if ('serviceWorker' in navigator) {
        log('   ‚úÖ API Supported');
        try {
          const registration = await navigator.serviceWorker.getRegistration();
          if (registration) {
            log('   ‚úÖ Registered');
            log(`   Scope: ${registration.scope}`);
            log(`   Active: ${registration.active ? 'Yes' : 'No'}`);
            if (registration.active) {
              log(`   State: ${registration.active.state}`);
              log(`   Script URL: ${registration.active.scriptURL}`);
            }
            log(`   Installing: ${registration.installing ? 'Yes' : 'No'}`);
            log(`   Waiting: ${registration.waiting ? 'Yes' : 'No'}`);
          } else {
            log('   ‚ö†Ô∏è Not Registered (normal in dev mode)');
          }
        } catch (error) {
          log(`   ‚ùå Error: ${error.message}`);
        }
      } else {
        log('   ‚ùå Not Supported');
      }
      log('');

      // 4. PWA
      log('üì± PWA Status:');
      const isPWA = window.matchMedia('(display-mode: standalone)').matches;
      log(`   Running as PWA: ${isPWA ? 'Yes' : 'No'}`);
      log(`   Display Mode: ${isPWA ? 'standalone' : 'browser'}`);
      log('');

      // 5. Permissions
      log('üîê Permissions:');
      if (navigator.permissions) {
        try {
          const result = await navigator.permissions.query({ name: 'notifications' });
          log(`   Notification Permission: ${result.state}`);
        } catch (error) {
          log(`   Cannot query: ${error.message}`);
        }
      } else {
        log('   Permissions API not available');
      }
      log('');

      // 6. Recommendations
      log('üí° Recommendations:');
      if (!('Notification' in window)) {
        log('   ‚ö†Ô∏è Use a modern browser (Chrome, Firefox, Edge, Safari)');
      }
      if (Notification.permission === 'denied') {
        log('   ‚ö†Ô∏è Reset notification permissions in browser settings');
        log('   üìç Chrome: Settings ‚Üí Privacy ‚Üí Site Settings ‚Üí Notifications');
        log('   üìç Firefox: Settings ‚Üí Privacy ‚Üí Permissions ‚Üí Notifications');
      }
      if (Notification.permission === 'default') {
        log('   ‚ÑπÔ∏è Click "Request Permission" to enable notifications');
      }
      if (!navigator.serviceWorker) {
        log('   ‚ö†Ô∏è Service Workers require HTTPS or localhost');
      }
      
      log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
      log('‚úÖ Diagnostic complete!');
      
      updateStatus();
    }

    // Initialize on load
    window.addEventListener('load', () => {
      updateStatus();
      log('‚úÖ Page loaded. Ready to test notifications!');
      log('‚ÑπÔ∏è Click the buttons above to start testing.');
    });

    // Listen for service worker messages
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.addEventListener('message', (event) => {
        log(`üì® Message from service worker: ${JSON.stringify(event.data)}`);
      });
    }
  </script>
</body>
</html>
